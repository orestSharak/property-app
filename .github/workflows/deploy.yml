name: Manual Deployment

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Deployment Target'
        type: choice
        required: true
        default: 'hosting'
        options:
          - hosting
          - functions
          - all

jobs:
  deploy:
    name: ðŸš€ Deploy to Firebase
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- Download and Extract Artifact (Robust Method) ---
      # This script finds the artifact from the latest successful CI run,
      # downloads it, and extracts its contents (the 'dist' folder) directly to the root.
      - name: Download Build Artifact from CI
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const workflow_id = 'ci-cd.yml';
            const artifact_name = 'vite-build-artifact';
            const { execSync } = require('child_process');
            const fs = require('fs');

            // 1. Find the latest successful run ID
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner, repo, workflow_id, status: 'success', branch: context.ref.replace('refs/heads/', ''),
            });
            if (!runs.workflow_runs.length) { core.setFailed(`No successful CI runs found. Aborting.`); return; }
            const latestRunId = runs.workflow_runs[0].id;

            // 2. Find the artifact ID
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner, repo, run_id: latestRunId,
            });
            const artifact = artifacts.artifacts.find(a => a.name === artifact_name);
            if (!artifact) { core.setFailed(`Artifact "${artifact_name}" not found. Aborting.`); return; }

            // 3. Download, save, and unzip the file directly to root
            const download = await github.rest.actions.downloadArtifact({
              owner, repo, artifact_id: artifact.id, archive_format: 'zip',
            });

            const zipPath = `${artifact_name}.zip`;
            fs.writeFileSync(zipPath, Buffer.from(download.data));
            execSync(`unzip -o ${zipPath} -d .`);
            execSync(`rm -f ${zipPath}`);
            core.info('Artifact downloaded, extracted, and "dist" folder is ready.');

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies and Firebase CLI
        run: |
          npm ci
          npm install -g firebase-tools

      - name: Construct Deployment Command
        id: deploy_command
        run: |
          DEPLOY_TARGETS=""
          case "${{ github.event.inputs.target }}" in
            "hosting")
              DEPLOY_TARGETS="hosting"
              ;;
            "functions")
              DEPLOY_TARGETS="functions"
              ;;
            "all")
              DEPLOY_TARGETS="hosting,functions"
              ;;
          esac
          echo "command=firebase deploy --only $DEPLOY_TARGETS" >> $GITHUB_OUTPUT

      - name: Run Firebase Deployment
        run: ${{ steps.deploy_command.outputs.command }} --token ${{ secrets.FIREBASE_TOKEN }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
