name: Manual Deployment

on:
  # Manual trigger with deployment options
  workflow_dispatch:
    inputs:
      target:
        description: 'Deployment Target'
        type: choice
        required: true
        default: 'hosting'
        options:
          - hosting
          - functions
          - all

jobs:
  deploy:
    name: Deploy to Firebase
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Build Artifact from CI
        uses: actions/github-script@v6
        id: download_ci_artifact
        with:
          script: |
            const { owner, repo } = context.repo;
            const workflow_id = 'ci-cd.yml'; // Name of your CI workflow file
            const artifact_name = 'vite-build-artifact';

            // 1. Find the latest successful run of the CI workflow
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id,
              status: 'success',
              branch: context.ref.replace('refs/heads/', ''), // Use current branch for safety
            });

            if (!runs.workflow_runs.length) {
              core.setFailed(`No successful CI runs found for workflow: ${workflow_id}`);
              return;
            }

            const latestRunId = runs.workflow_runs[0].id;

            // 2. Find the artifact ID within that run
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: latestRunId,
            });

            const artifact = artifacts.artifacts.find(a => a.name === artifact_name);

            if (!artifact) {
              core.setFailed(`Artifact "${artifact_name}" not found in run ${latestRunId}.`);
              return;
            }

            // 3. Download the artifact using the found ID
            const download = await github.rest.actions.downloadArtifact({
              owner,
              repo,
              artifact_id: artifact.id,
              archive_format: 'zip',
            });

            // Save the zip file
            const fs = require('fs');
            fs.writeFileSync(`${artifact_name}.zip`, Buffer.from(download.data));

            // Unzip the file
            const { execSync } = require('child_process');
            execSync(`unzip -o ${artifact_name}.zip -d .`);

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies and Firebase CLI
        run: |
          npm ci
          npm install -g firebase-tools

      - name: Construct Deployment Command
        id: deploy_command
        run: |
          DEPLOY_TARGETS=""
          case "${{ github.event.inputs.target }}" in
            "hosting")
              DEPLOY_TARGETS="hosting"
              ;;
            "functions")
              DEPLOY_TARGETS="functions"
              ;;
            "all")
              DEPLOY_TARGETS="hosting,functions"
              ;;
          esac
          echo "command=firebase deploy --only $DEPLOY_TARGETS" >> $GITHUB_OUTPUT

      - name: Run Firebase Deployment
        run: ${{ steps.deploy_command.outputs.command }} --token ${{ secrets.FIREBASE_TOKEN }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
