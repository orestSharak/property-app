name: Manual Deployment

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Deployment Target'
        type: choice
        required: true
        default: 'hosting'
        options:
          - hosting
          - functions
          - all

# --- JOB 1: FIND ARTIFACT INFO ---
jobs:
  get-artifact-info:
    name: ðŸ”Ž Get Latest CI Artifact Info
    runs-on: ubuntu-latest
    # We only need the run_id now, but we'll keep the output structure clean.
    outputs:
      run_id: ${{ steps.find_run.outputs.run_id }}

    steps:
      - name: Find Latest Successful CI Run ID
        uses: actions/github-script@v6
        id: find_run
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci-cd.yml',
              status: 'success',
              branch: context.ref.replace('refs/heads/', ''),
            });

            if (!runs.workflow_runs.length) {
              core.setFailed("No successful CI runs found. Deployment aborted.");
              return;
            }

            const latestRunId = runs.workflow_runs[0].id;
            core.setOutput('run_id', latestRunId);

  # --- JOB 2: DEPLOY (Uses Info from Job 1) ---
  deploy:
    name: ðŸš€ Deploy to Firebase
    needs: get-artifact-info
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- Corrected Artifact Download Step ---
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          # Use the RUN ID from the previous job's output
          run-id: ${{ needs.get-artifact-info.outputs.run_id }}
          # Use the ARTIFACT NAME (mandatory for v4)
          name: vite-build-artifact
          # Download directly to the root, ensuring 'dist' is at the top level
          path: .

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies and Firebase CLI
        run: |
          npm ci
          npm install -g firebase-tools

      - name: Construct Deployment Command
        id: deploy_command
        run: |
          DEPLOY_TARGETS=""
          case "${{ github.event.inputs.target }}" in
            "hosting")
              DEPLOY_TARGETS="hosting"
              ;;
            "functions")
              DEPLOY_TARGETS="functions"
              ;;
            "all")
              DEPLOY_TARGETS="hosting,functions"
              ;;
          esac
          echo "command=firebase deploy --only $DEPLOY_TARGETS" >> $GITHUB_OUTPUT

      - name: Run Firebase Deployment
        run: ${{ steps.deploy_command.outputs.command }} --token ${{ secrets.FIREBASE_TOKEN }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
