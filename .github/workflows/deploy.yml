name: Manual Deployment

on:
  # Manual trigger with deployment options
  workflow_dispatch:
    inputs:
      target:
        description: 'Deployment Target'
        type: choice
        required: true
        default: 'hosting'
        options:
          - hosting
          - functions
          - all

jobs:
  deploy:
    name: ðŸš€ Deploy to Firebase
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- Critical Fix: Find, Download, and Extract Artifact using Script ---
      - name: Download Build Artifact from CI
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const workflow_id = 'ci-cd.yml'; // Name of your CI workflow file
            const artifact_name = 'vite-build-artifact';
            const { execSync } = require('child_process');
            const fs = require('fs');

            core.info(`Searching for artifact: ${artifact_name} from successful run of ${workflow_id}`);

            // 1. Find the latest successful run of the CI workflow
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id,
              status: 'success',
              branch: context.ref.replace('refs/heads/', ''),
            });

            if (!runs.workflow_runs.length) {
              core.setFailed(`No successful CI runs found for workflow: ${workflow_id}. Deployment aborted.`);
              return;
            }

            const latestRunId = runs.workflow_runs[0].id;
            core.info(`Found latest successful run ID: ${latestRunId}`);

            // 2. Find the artifact ID within that run
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: latestRunId,
            });

            const artifact = artifacts.artifacts.find(a => a.name === artifact_name);

            if (!artifact) {
              core.setFailed(`Artifact "${artifact_name}" not found in run ${latestRunId}. Deployment aborted.`);
              return;
            }

            // 3. Download the artifact ZIP file
            core.info(`Downloading artifact ID: ${artifact.id}`);
            const download = await github.rest.actions.downloadArtifact({
              owner,
              repo,
              artifact_id: artifact.id,
              archive_format: 'zip',
            });

            // 4. Save the zip file
            const zipPath = `${artifact_name}.zip`;
            fs.writeFileSync(zipPath, Buffer.from(download.data));

            // 5. Unzip the file directly into the current directory ('.')
            // This ensures the 'dist' folder is at the root for Firebase.
            execSync(`unzip -o ${zipPath} -d .`);
            core.info('Artifact unzipped successfully. "dist" folder should now be available.');

            // 6. Clean up the zip file
            execSync(`rm -f ${zipPath}`);

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies and Firebase CLI
        run: |
          npm ci
          npm install -g firebase-tools

      - name: Construct Deployment Command
        id: deploy_command
        run: |
          DEPLOY_TARGETS=""
          case "${{ github.event.inputs.target }}" in
            "hosting")
              DEPLOY_TARGETS="hosting"
              ;;
            "functions")
              DEPLOY_TARGETS="functions"
              ;;
            "all")
              DEPLOY_TARGETS="hosting,functions"
              ;;
          esac
          echo "command=firebase deploy --only $DEPLOY_TARGETS" >> $GITHUB_OUTPUT

      - name: Run Firebase Deployment
        run: ${{ steps.deploy_command.outputs.command }} --token ${{ secrets.FIREBASE_TOKEN }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
